<mark style="background: #FFF3A3A6;">ToDo:</mark>
- [x] <mark style="background: #BBFABBA6;">Створити клас, який буде відповідати за шифрування/розшифрування даних ✅ 2024-03-19</mark>
- [x] <mark style="background: #BBFABBA6;">Створити клас, який буде описувати віртуальну машину користувача ✅ 2024-03-20</mark>
- [x] <mark style="background: #BBFABBA6;">Створити та прокинути міграції в базу даних ✅ 2024-03-20</mark>
- [ ] Створити сервіс для взаємодії із базою даних віртуальних машин
- [ ] Написати контролер для методів сервісу

## Створити клас, який буде відповідати за шифрування/розшифрування даних
Оскільки виконувати операції шифрування/розшифрування та хешування тепер необхідно виконувати не тільки в AuthService, а й в інших частинах коду, то вирішено всі методу необхідні для цього винести в окремий статичний клас CryptoService:
```CSharp
public static class CryptoService
{
    public static string BlowfishKey { get; set; } = "SomeSecretKey";

    public static string ComputeSha256Hash(string? data)
    {
        if (data == null)
        {
            return "";
        }

        var bytes = SHA256.HashData(Encoding.UTF8.GetBytes(data));
        var strBuilder = new StringBuilder();

        foreach (var _ in bytes)
        {
            strBuilder.Append(_.ToString("x2"));
        }

        return strBuilder.ToString();
    }

    public static string Blowfish(string? data, bool encrypt = true)
    {
        if (data == null)
        {
            return "";
        }

        var dataBytes = encrypt ? Encoding.UTF8.GetBytes(data) : Convert.FromBase64String(data);
        var cipher = new BufferedBlockCipher(new CbcBlockCipher(new BlowfishEngine()));

        while (dataBytes.Length % 8 != 0)
        {
            dataBytes = [..dataBytes, 0];
        }

        cipher.Init(encrypt, new KeyParameter(Encoding.UTF8.GetBytes(BlowfishKey)));

        var outputDataBytes = new byte[cipher.GetOutputSize(dataBytes.Length)];
        var length = cipher.ProcessBytes(dataBytes, 0, dataBytes.Length, outputDataBytes, 0);

        cipher.DoFinal(outputDataBytes, length);

        return encrypt ? Convert.ToBase64String(outputDataBytes) : Encoding.UTF8.GetString(outputDataBytes);
    }
}
```

Також в даний клас було додано метод Blowfish, який буде в майбутньому використовуватися для шифрування паролів для SSH підключення до віртуальної машини.
## Створити клас, який буде описувати віртуальну машину користувача
Було створено клас VirtualMachine, в якому описані поля, які будуть необхідні для підключення до віртуальної машини за допомогою SSH, а також поля, які характеризують належність до певного користувача:
```CSharp
public class VirtualMachine
{
    public int Id { get; set; }
    public string? Name { get; set; }
    public long UserTelegramId { get; set; }
    public string? Username { get; set; }
    public string? PasswordEncrypted { get; set; }
    public string? Password { get => CryptoService.Blowfish(PasswordEncrypted, false); set { } }
    public string? Host { get; set;}
    public int Port { get; set; }
}
```
## Створити та прокинути міграції в базу даних
Було створено клас AppDbContext. Це клас, який буде напряму взаємодіяти із базою даних та буде відповідати за всі інші сутності, які не увійшли в UserDbContext:
```CSharp
public class AppDbContext : DbContext
{
    public virtual DbSet<VirtualMachine> VirtualMachines { get; set; }

    public AppDbContext()
    {

    }

    public AppDbContext(DbContextOptions<AppDbContext> options) : base(options) 
    { 
    
    }
}
```

Для сутності VirtualMachine було створено файл конфігурації, в якому описано як і які саме поля із сутності зберігати в базу даних:
```CSharp
public class VirtualMachineConfiguration : IEntityTypeConfiguration<VirtualMachine>
{
    public void Configure(EntityTypeBuilder<VirtualMachine> builder)
    {
        builder.Property(_ => _.Id)
               .IsRequired()
               .UseIdentityColumn();

        builder.Property(_ => _.Name)
               .IsRequired();

        builder.Property(_ => _.UserTelegramId)
               .IsRequired();

        builder.Property(_ => _.Username)
               .IsRequired();

        builder.Property(_ => _.PasswordEncrypted)
               .IsRequired();

        builder.Property(_ => _.Host)
               .IsRequired();

        builder.Property(_ => _.Port)
               .IsRequired();
        
        builder.Ignore(_ => _.Password);
    }
}
```

Цю конфігурацію було застосовано:
```CSharp
protected override void OnModelCreating(ModelBuilder modelBuilder)
{
    base.OnModelCreating(modelBuilder);

    modelBuilder.ApplyConfiguration(new VirtualMachineConfiguration());
}
```

Для створення та прокидання потрібно встановити дві бібліотеки: Microsoft.EntityFrameworkCore.Design та Microsoft.EntityFrameworkCore.Tools

Команда для створення міграцій:
```
Add-Migration Init -o Data/Migrations
```

Файл міграції:
```CSharp
public partial class Init : Migration
{
    /// <inheritdoc />
    protected override void Up(MigrationBuilder migrationBuilder)
    {
        migrationBuilder.CreateTable(
            name: "VirtualMachines",
            columns: table => new
            {
                Id = table.Column<int>(type: "int", nullable: false)
                    .Annotation("SqlServer:Identity", "1, 1"),
                Name = table.Column<string>(type: "nvarchar(max)", nullable: false),
                UserTelegramId = table.Column<long>(type: "bigint", nullable: false),
                Username = table.Column<string>(type: "nvarchar(max)", nullable: false),
                PasswordEncrypted = table.Column<string>(type: "nvarchar(max)", nullable: false),
                Host = table.Column<string>(type: "nvarchar(max)", nullable: false),
                Port = table.Column<int>(type: "int", nullable: false)
            },
            constraints: table =>
            {
                table.PrimaryKey("PK_VirtualMachines", x => x.Id);
            });
    }

    /// <inheritdoc />
    protected override void Down(MigrationBuilder migrationBuilder)
    {
        migrationBuilder.DropTable(
            name: "VirtualMachines");
    }
}
```

Команда для прокидання міграції:
```
Update-Database
```
